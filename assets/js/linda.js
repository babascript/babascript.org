var Linda=function(a,b){var c=this;this.io=null,this.io=null===a||"undefined"==typeof a?(new RocketIO).connect():a,this.opts=b||{},this.TupleSpace=function(a){(null===a||"string"!=typeof a)&&(a="__default__"),this.name=a,this.linda=c;var b=this,d=function(){return new Date-0+"_"+Math.floor(1e6*Math.random())};this.write=function(a,d){null!==a&&"object"==typeof a&&((null===d||"undefined"==typeof d)&&(d={}),c.io.push("__linda_write",[b.name,a,d]))},this.read=function(a,e){if(null!==a&&"object"==typeof a&&"function"==typeof e){var f=d();c.io.once("__linda_read_callback_"+f,function(a){e(a.tuple,a.info)}),c.io.push("__linda_read",[b.name,a,f])}},this.take=function(a,e){if(null!==a&&"object"==typeof a&&"function"==typeof e){var f=d();c.io.once("__linda_take_callback_"+f,function(a){e(a.tuple,a.info)}),c.io.push("__linda_take",[b.name,a,f])}},this.watch=function(a,e){if(null!==a&&"object"==typeof a&&"function"==typeof e){var f=d();c.io.on("__linda_watch_callback_"+f,function(a){e(a.tuple,a.info)}),c.io.push("__linda_watch",[b.name,a,f])}},this.list=function(a,e){if(null!==a&&"object"==typeof a&&"function"==typeof e){var f=d();c.io.on("__linda_list_callback_"+f,function(a){e(a)}),c.io.push("__linda_list",[b.name,a,f])}}}},RocketIO=function(a){(new EventEmitter).apply(this),("undefined"==typeof a||null===a)&&(a={}),this.type=a.type||null,this.session=a.session||null,this.channel=null,"undefined"!=typeof a.channel&&null!==a.channel&&(this.channel=""+a.channel);var b={};this.io=null;var c=this,d=null;c.on("__connect",function(a){c.session=a,c.io.push("__channel_id",c.channel),c.emit("connect")}),this.connect=function(a){return"string"==typeof a?($.getJSON(a+"/rocketio/settings",function(a){b=a,e()}),c):e()};var e=function(){return c.io=function(){if("comet"!==c.type&&"function"==typeof WebSocketIO){var a=new WebSocketIO;return"string"==typeof b.websocket&&(a.url=b.websocket),a.session=c.session,a.connect()}}()||function(){if("function"==typeof CometIO){var a=new CometIO;return"string"==typeof b.comet&&(a.url=b.comet),a.session=c.session,a.connect()}}(),"undefined"==typeof c.io?(setTimeout(function(){c.emit("error","WebSocketIO and CometIO are not available")},100),c):(c.type=c.io.url.match(/^ws:\/\/.+/)?"websocket":c.io.url.match(/cometio/)?"comet":"unknown",c.io.on("*",function(a,b){"connect"===a&&(a="__connect"),c.emit(a,b)}),d=setTimeout(function(){c.close(),c.type="comet",e()},3e3),c.once("connect",function(){d&&clearTimeout(d),d=null}),c)};this.close=function(){c.io.close()},this.push=function(a,b){c.io.push(a,b)}},CometIO=function(a,b){(new EventEmitter).apply(this),("undefined"==typeof b||null===b)&&(b={}),this.url=a||"http://linda.masuilab.org/cometio/io",this.session=b.session||null;var c=!1,d=this,e=[],f=function(){if(c&&!(e.length<1)){var a={json:JSON.stringify({session:d.session,events:e})};$.ajax({url:d.url,data:a,success:function(){},error:function(){d.emit("error","CometIO push error")},complete:function(){},type:"POST",dataType:"json",timeout:1e4}),e=[]}};setInterval(f,1e3),this.push=function(a,b){return c&&d.session?(e.push({type:a,data:b}),void 0):(d.emit("error","CometIO not connected"),void 0)},this.connect=function(){return c?d:(d.on("__session_id",function(a){d.session=a,d.emit("connect",d.session)}),c=!0,g(),d)},this.close=function(){c=!1,d.removeListener("__session_id")};var g=function(){c&&$.ajax({url:d.url+"?"+(new Date-0),data:{session:d.session},success:function(a){if(null!==a&&"object"==typeof a&&a.length)for(var b=0;b<a.length;b++){var c=a[b];c&&d.emit(c.type,c.data)}g()},error:function(){d.emit("error","CometIO get error"),setTimeout(g,1e4)},complete:function(){},type:"GET",dataType:"json",timeout:13e4})}},WebSocketIO=function(a,b){(new EventEmitter).apply(this),("undefined"==typeof b||null===b)&&(b={}),this.url=a||"ws://linda.masuilab.org:10010",this.session=b.session||null,this.websocket=null,this.connecting=!1;var c=null,d=this;d.on("__session_id",function(a){d.session=a,d.emit("connect",d.session)}),this.connect=function(){if("undefined"==typeof WebSocket)return d.emit("error","websocket not exists in this browser"),null;d.running=!0;var a=d.session?d.url+"/session="+d.session:d.url;return d.websocket=new WebSocket(a),d.websocket.onmessage=function(a){var b=null;try{b=JSON.parse(a.data)}catch(a){d.emit("error","WebSocketIO data parse error")}b&&d.emit(b.type,b.data)},d.websocket.onclose=function(){d.connecting&&(d.connecting=!1,d.emit("disconnect")),d.running&&(c=setTimeout(d.connect,1e4))},d.websocket.onopen=function(){d.connecting=!0},d},this.close=function(){clearTimeout(c),d.running=!1,d.websocket.close()},this.push=function(a,b){return d.connecting?(d.websocket.send(JSON.stringify({type:a,data:b,session:d.session})),void 0):(d.emit("error","websocket not connected"),void 0)}},EventEmitter=function(){var a=this;this.apply=function(b,c){c||(c="");for(var d in a)a.hasOwnProperty(d)&&"apply"!==d&&(b[c+d]=this[d])},this.__events=new Array,this.on=function(b,c,d){if("function"==typeof c){var e=a.__events.length>0?1+a.__events[a.__events.length-1].id:0,f={id:e,type:b,listener:c};for(i in d)f[i]||(f[i]=d[i]);return a.__events.push(f),e}},this.once=function(b,c){a.on(b,c,{once:!0})},this.emit=function(b,c){for(var d=0;d<a.__events.length;d++){var e=a.__events[d];switch(e.type){case b:e.listener(c),e.once&&(e.type=null);break;case"*":e.listener(b,c),e.once&&(e.type=null)}}a.removeListener()},this.removeListener=function(b){for(var c=a.__events.length-1;c>=0;c--){var d=a.__events[c];switch(typeof b){case"number":d.id===b&&a.__events.splice(c,1);break;case"string":case"object":d.type===b&&a.__events.splice(c,1)}}}};"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports=EventEmitter);